{"version":3,"sources":["../utils/index.js","../utils/Http.js","init.js"],"names":["log4js","require","tempdir","os","tmpdir","exitCli","process","exit","getLog4jsInstance","configure","appenders","lxl","type","filename","path","join","categories","default","level","getLogger","saveCertificate","value","Error","confPath","fs","writeFile","err","getCertificate","existsSync","readFileSync","encoding","log","info","console","error","Header","Accept","COURSE_TEST_URL","TAPD_TEST_URL","Http","constructor","timeout","withCredentials","request","option","conf","maxRedirects","instance","axios","create","createRequestOption","referer","headers","Referer","validCourseToken","token","successCallbackFunc","errorCallbackFunc","testUrl","http","client","then","resp","debug","data","status","code","catch","Init","query","setQuery","React","useState","end","setEnd","waiting","setWaiting","result","setResult","hasSelect","setHasSelect","select","setSelect","handleSelect","item","items","label","handleSubmit","setTimeout"],"mappings":"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","file":"init.js","sourceRoot":"..\\..\\commands","sourcesContent":["import fs from 'fs'\r\nimport os, { type } from 'os'\r\nimport path from 'path'\r\nconst log4js = require('log4js')\r\n// basic vars\r\nconst tempdir = os.tmpdir()\r\n// 通用退出函数\r\nconst exitCli = () => process.exit()\r\n\r\nconst getLog4jsInstance = () => {\r\n  log4js.configure({\r\n    appenders: {\r\n      lxl: { type: 'file', filename: path.join(tempdir, 'lxl.log') }\r\n    },\r\n    categories: { default: { appenders: ['lxl'], level: 'debug' } }\r\n  })\r\n  return log4js.getLogger('lxl')\r\n}\r\n\r\nconst saveCertificate = (type = 'course', value) => {\r\n  if (type !== 'course' && type !== 'tapd') {\r\n    throw new Error('暂不支持的凭证类型')\r\n  }\r\n  const confPath = path.join(tempdir, `${type}.txt`)\r\n  fs.writeFile(confPath, value, (err) => {\r\n    if (err) throw new Error('save certificate failed.')\r\n  })\r\n}\r\n\r\n// get certificate and check valid\r\nconst getCertificate = (type = 'course') => {\r\n  if (type !== 'course' && type !== 'tapd') {\r\n    throw new Error('暂不支持的凭证类型')\r\n  }\r\n  const confPath = path.join(tempdir, `${type}.txt`)\r\n  try {\r\n    if (fs.existsSync(confPath)) {\r\n      return fs.readFileSync(confPath, { encoding: 'utf8' })\r\n    } else {\r\n      log.info('先使用 lxl build init 命令进行初始化再重新运行程序.')\r\n      console.log('先使用 lxl build init 命令进行初始化再重新运行程序.')\r\n      exitCli()\r\n    }\r\n  } catch (error) {\r\n    throw new Error('read certificate failed.')\r\n  }\r\n}\r\n\r\nexport { tempdir, getCertificate, saveCertificate, getLog4jsInstance, exitCli }\r\n","import axios from 'axios'\r\nimport {\r\n  exitCli,\r\n  getCertificate,\r\n  getLog4jsInstance,\r\n  saveCertificate\r\n} from './index'\r\n\r\nconst Header = {\r\n  'User-Agent':\r\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36',\r\n  Accept: 'application/json, text/plain, */*',\r\n  'Content-Type': 'application/json;charset=UTF-8'\r\n}\r\n\r\nconst COURSE_TEST_URL = 'http://course.suboy.cn/cgi/auth/build/course/list'\r\nconst TAPD_TEST_URL =\r\n  'https://www.tapd.cn/company/participant_projects?from=left_tree2'\r\n\r\nexport default class Http {\r\n  constructor () {\r\n    this.timeout = 6000\r\n    this.withCredentials = true\r\n  }\r\n\r\n  /*\r\n   * option 需要提供 header dict, baseURL\r\n   */\r\n  request (option) {\r\n    const conf = {\r\n      ...option,\r\n      timeout: this.timeout,\r\n      withCredentials: this.withCredentials,\r\n      maxRedirects: 0\r\n    }\r\n    const instance = axios.create(conf)\r\n    return instance\r\n  }\r\n}\r\n\r\nfunction createRequestOption (\r\n  type = 'course',\r\n  referer = 'http://course.suboy.cn/'\r\n) {\r\n  const conf = {\r\n    headers: {\r\n      ...Header,\r\n      [type === 'course' ? 'token' : 'cookie']: getCertificate(type),\r\n      Referer: referer\r\n    }\r\n  }\r\n  return conf\r\n}\r\n\r\nfunction validCourseToken (type, token, successCallbackFunc, errorCallbackFunc) {\r\n  const log = getLog4jsInstance()\r\n  const testUrl = type === 'course' ? COURSE_TEST_URL : TAPD_TEST_URL\r\n  const http = new Http()\r\n  const client = http.request({\r\n    headers: {\r\n      [type === 'course' ? 'token' : 'cookie']: token,\r\n      ...Header\r\n    }\r\n  })\r\n  client[type === 'course' ? 'post' : 'get'](testUrl)\r\n    .then((resp) => {\r\n      log.info('start check token/cookie valid...')\r\n      log.debug(resp.data, resp.status)\r\n      if (resp.data.code == 0 || resp.status == 200) {\r\n        saveCertificate(type, token)\r\n        successCallbackFunc()\r\n      } else {\r\n        errorCallbackFunc(resp.data)\r\n      }\r\n    })\r\n    .catch((err) => errorCallbackFunc(err))\r\n}\r\n\r\nexport { Header, validCourseToken, createRequestOption }\r\n","import React from 'react'\r\nimport TextInput from 'ink-text-input'\r\nimport Spinner from 'ink-spinner'\r\nimport { Box, Text } from 'ink'\r\nimport { getLog4jsInstance } from '../utils'\r\nimport { validCourseToken } from '../utils/Http'\r\nimport SelectInput from 'ink-select-input'\r\nimport Divider from 'ink-divider'\r\n\r\nconst log = getLog4jsInstance()\r\n\r\n/// init, input your token.\r\nconst Init = () => {\r\n  const [query, setQuery] = React.useState('')\r\n  const [end, setEnd] = React.useState(false)\r\n  const [waiting, setWaiting] = React.useState(false)\r\n  const [result, setResult] = React.useState('')\r\n  const [hasSelect, setHasSelect] = React.useState(false)\r\n  const [select, setSelect] = React.useState('')\r\n  const handleSelect = (item) => {\r\n    // `item` = { label: 'First', value: 'first' }\r\n    setSelect(item.value)\r\n    setHasSelect(true)\r\n  }\r\n\r\n  const items = [\r\n    {\r\n      label: '通用配置管理',\r\n      value: 'course'\r\n    },\r\n    {\r\n      label: 'TAPD需求管理',\r\n      value: 'tapd'\r\n    }\r\n  ]\r\n  // 提供正确和错误的回调函数\r\n  function handleSubmit () {\r\n    if (query !== '') {\r\n      setWaiting(true)\r\n      validCourseToken(\r\n        select,\r\n        query,\r\n        () => {\r\n          setEnd(true)\r\n          setResult('Ok.')\r\n          setTimeout(() => {\r\n            process.exit()\r\n          }, 1000)\r\n        },\r\n        (err) => {\r\n          setEnd(true)\r\n          setResult('Failed.无效的凭证.')\r\n          log.debug(err)\r\n          setTimeout(() => {\r\n            process.exit()\r\n          }, 1000)\r\n        }\r\n      )\r\n    }\r\n  }\r\n  return (\r\n    <Box flexDirection='column'>\r\n      <Divider title='CLI Token/Cookie Init.' />\r\n      <SelectInput items={items} onSelect={handleSelect} />\r\n      {hasSelect ? (\r\n        <Box>\r\n          <Box marginRight={1}>\r\n            <Text color='greenBright'>\r\n              CLI init.Enter your {select === 'course' ? 'token' : 'cookie'}:\r\n            </Text>\r\n          </Box>\r\n          <TextInput\r\n            value={query}\r\n            onChange={setQuery}\r\n            onSubmit={handleSubmit}\r\n          />\r\n        </Box>\r\n      ) : null}\r\n      {waiting ? (\r\n        <Box>\r\n          {end ? (\r\n            <Text color='green'>{result}</Text>\r\n          ) : (\r\n            <Text>\r\n              <Text color='green'>\r\n                <Spinner type='dots12' />\r\n              </Text>\r\n              {'check token valid...'}\r\n            </Text>\r\n          )}\r\n        </Box>\r\n      ) : null}\r\n    </Box>\r\n  )\r\n}\r\n\r\nexport default Init\r\n"]}