{"version":3,"sources":["../utils/index.js","../utils/Http.js","init.js"],"names":["log4js","require","tempdir","os","tmpdir","exitCli","process","exit","getLog4jsInstance","configure","appenders","lxl","type","filename","path","join","categories","default","level","getLogger","saveCertificate","value","Error","confPath","fs","writeFile","err","getCertificate","existsSync","readFileSync","encoding","log","info","console","error","Header","Accept","COURSE_TEST_URL","TAPD_TEST_URL","Http","constructor","timeout","withCredentials","request","option","conf","maxRedirects","instance","axios","create","createRequestOption","referer","customConf","customHeader","headers","Referer","validCourseToken","token","successCallbackFunc","errorCallbackFunc","testUrl","http","client","then","resp","debug","data","status","code","catch","Init","query","setQuery","React","useState","end","setEnd","waiting","setWaiting","result","setResult","hasSelect","setHasSelect","select","setSelect","handleSelect","item","items","label","handleSubmit","setTimeout"],"mappings":"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","file":"init.js","sourceRoot":"..\\..\\commands","sourcesContent":["import fs from 'fs'\nimport os, { type } from 'os'\nimport path from 'path'\nconst log4js = require('log4js')\n// basic vars\nconst tempdir = os.tmpdir()\n// 通用退出函数\nconst exitCli = () => process.exit()\n\nconst getLog4jsInstance = () => {\n  log4js.configure({\n    appenders: {\n      lxl: { type: 'file', filename: path.join(tempdir, 'lxl.log') }\n    },\n    categories: { default: { appenders: ['lxl'], level: 'debug' } }\n  })\n  return log4js.getLogger('lxl')\n}\n\nconst saveCertificate = (type = 'course', value) => {\n  if (type !== 'course' && type !== 'tapd') {\n    throw new Error('暂不支持的凭证类型')\n  }\n  const confPath = path.join(tempdir, `${type}.txt`)\n  fs.writeFile(confPath, value, (err) => {\n    if (err) throw new Error('save certificate failed.')\n  })\n}\n\n// get certificate and check valid\nconst getCertificate = (type = 'course') => {\n  if (type !== 'course' && type !== 'tapd') {\n    throw new Error('暂不支持的凭证类型')\n  }\n  const confPath = path.join(tempdir, `${type}.txt`)\n  try {\n    if (fs.existsSync(confPath)) {\n      return fs.readFileSync(confPath, { encoding: 'utf8' })\n    } else {\n      log.info('先使用 lxl build init 命令进行初始化再重新运行程序.')\n      console.log('先使用 lxl build init 命令进行初始化再重新运行程序.')\n      exitCli()\n    }\n  } catch (error) {\n    throw new Error('read certificate failed.')\n  }\n}\n\nexport { tempdir, getCertificate, saveCertificate, getLog4jsInstance, exitCli }\n","import axios from 'axios'\nimport {\n  // exitCli,\n  getCertificate,\n  getLog4jsInstance,\n  saveCertificate\n} from './index'\n\nconst Header = {\n  'User-Agent':\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36',\n  Accept: 'application/json, text/plain, */*',\n  'Content-Type': 'application/json;charset=UTF-8'\n}\n\nconst COURSE_TEST_URL = 'http://course.suboy.cn/cgi/auth/build/course/list'\nconst TAPD_TEST_URL =\n  'https://www.tapd.cn/company/participant_projects?from=left_tree2'\n\nexport default class Http {\n  constructor () {\n    this.timeout = 6000\n    this.withCredentials = true\n  }\n\n  /*\n   * option 需要提供 header dict, baseURL\n   */\n  request (option) {\n    const conf = {\n      ...option,\n      timeout: this.timeout,\n      withCredentials: this.withCredentials,\n      maxRedirects: 0\n    }\n    const instance = axios.create(conf)\n    return instance\n  }\n\n  // createInstance\n}\n\nfunction createRequestOption (\n  type = 'course',\n  referer = 'http://course.suboy.cn/',\n  customConf = {},\n  customHeader = null\n) {\n  const conf = {\n    headers: {\n      ...(customHeader === null ? Header : customHeader),\n      [type === 'course' ? 'token' : 'cookie']: getCertificate(type),\n      Referer: referer\n    },\n    ...customConf\n  }\n  return conf\n}\n\nfunction validCourseToken (type, token, successCallbackFunc, errorCallbackFunc) {\n  const log = getLog4jsInstance()\n  const testUrl = type === 'course' ? COURSE_TEST_URL : TAPD_TEST_URL\n  const http = new Http()\n  const client = http.request({\n    headers: {\n      [type === 'course' ? 'token' : 'cookie']: token,\n      ...Header\n    }\n  })\n  client[type === 'course' ? 'post' : 'get'](testUrl)\n    .then((resp) => {\n      log.info('start check token/cookie valid...')\n      log.debug(resp.data, resp.status)\n      if (resp.data.code === 0 || resp.status === 200) {\n        saveCertificate(type, token)\n        successCallbackFunc()\n      } else {\n        errorCallbackFunc(resp.data)\n      }\n    })\n    .catch((err) => errorCallbackFunc(err))\n}\n\nexport { Header, validCourseToken, createRequestOption }\n","import React from 'react'\nimport TextInput from 'ink-text-input'\nimport Spinner from 'ink-spinner'\nimport { Box, Text } from 'ink'\nimport { getLog4jsInstance } from '../utils'\nimport { validCourseToken } from '../utils/Http'\nimport SelectInput from 'ink-select-input'\nimport Divider from 'ink-divider'\n\nconst log = getLog4jsInstance()\n\n/// init, input your token.\nconst Init = () => {\n  const [query, setQuery] = React.useState('')\n  const [end, setEnd] = React.useState(false)\n  const [waiting, setWaiting] = React.useState(false)\n  const [result, setResult] = React.useState('')\n  const [hasSelect, setHasSelect] = React.useState(false)\n  const [select, setSelect] = React.useState('')\n  const handleSelect = (item) => {\n    // `item` = { label: 'First', value: 'first' }\n    setSelect(item.value)\n    setHasSelect(true)\n  }\n\n  const items = [\n    {\n      label: '通用配置管理',\n      value: 'course'\n    },\n    {\n      label: 'TAPD需求管理',\n      value: 'tapd'\n    }\n  ]\n  // 提供正确和错误的回调函数\n  function handleSubmit () {\n    if (query !== '') {\n      setWaiting(true)\n      validCourseToken(\n        select,\n        query,\n        () => {\n          setEnd(true)\n          setResult('Ok.')\n          setTimeout(() => {\n            process.exit()\n          }, 1000)\n        },\n        (err) => {\n          setEnd(true)\n          setResult('Failed.无效的凭证.')\n          log.debug(err)\n          setTimeout(() => {\n            process.exit()\n          }, 1000)\n        }\n      )\n    }\n  }\n  return (\n    <Box flexDirection='column'>\n      <Divider title='CLI Token/Cookie Init.' />\n      <SelectInput items={items} onSelect={handleSelect} />\n      {hasSelect ? (\n        <Box>\n          <Box marginRight={1}>\n            <Text color='greenBright'>\n              CLI init.Enter your {select === 'course' ? 'token' : 'cookie'}:\n            </Text>\n          </Box>\n          <TextInput\n            value={query}\n            onChange={setQuery}\n            onSubmit={handleSubmit}\n          />\n        </Box>\n      ) : null}\n      {waiting ? (\n        <Box>\n          {end ? (\n            <Text color='green'>{result}</Text>\n          ) : (\n            <Text>\n              <Text color='green'>\n                <Spinner type='dots12' />\n              </Text>\n              {'check token valid...'}\n            </Text>\n          )}\n        </Box>\n      ) : null}\n    </Box>\n  )\n}\n\nexport default Init\n"]}